name: Android CI

on:
  pull_request:
    branches: [ main, develop ]

env:
  JAVA_VERSION: '21.0.8'
  GRADLE_OPTS: >-
    -Dorg.gradle.daemon=false
    -Dorg.gradle.caching=true
    -Dorg.gradle.configuration-cache=true

jobs:
  ktlint:
    name: Ktlint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Run ktlint
        run: ./gradlew ktlintCheck -Pktlint.ignoreFailures=true

      - name: Upload ktlint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ktlint-report
          path: app/build/reports/ktlint/

  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Run Unit Tests
        run: ./gradlew test

  coverage:
    name: Integration Tests + Coverage (Kover)
    runs-on: ubuntu-latest
    needs: [ ktlint, test ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Enable KVM permissions
        run: |
          ls -la /dev/kvm || true
          if [ -e /dev/kvm ]; then
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
            ls -la /dev/kvm
          else
            echo "/dev/kvm no existe en este runner"
          fi

      - name: Run instrumentation tests (connectedDebugAndroidTest)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          disable-linux-hw-accel: false
          disable-animations: true
          emulator-boot-timeout: 900
          emulator-options: >-
            -no-window
            -no-audio
            -no-boot-anim
            -no-snapshot
            -gpu swiftshader_indirect
            -no-metrics
          script: |
            adb kill-server || true
            pkill -f adb || true
            rm -rf ~/.android/adbkey* || true
            adb start-server
            adb devices

            ./gradlew :app:connectedDebugAndroidTest --stacktrace

      - name: Run unit tests (debug)
        run: ./gradlew :app:testDebugUnitTest --stacktrace

      - name: Generate merged Kover reports
        run: |
          ./gradlew koverXmlReport koverHtmlReport --stacktrace

      - name: Upload instrumentation test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-instrumentation-test-reports
          path: |
            app/build/reports/androidTests/
            app/build/outputs/androidTest-results/

      - name: Upload Kover merged coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kover-merged-coverage
          path: |
            **/build/reports/kover/merged/html/
            **/build/reports/kover/merged/xml/

  assemble_debug:
    name: Assemble Debug
    runs-on: ubuntu-latest
    needs: [ ktlint, test ]

    if: github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Assemble Debug
        run: ./gradlew assembleDebug

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: app/build/outputs/apk/debug/*.apk
